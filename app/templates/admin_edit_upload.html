{% extends "base.html" %}

{% block content %}
<h2>Edit QSO Data</h2>

<div style="max-width: 1000px; width: 100%;">

<form method="POST">

    <input type="hidden" name="total_qsos" value="{{ qsos|length }}">

    <style>
        .qso-row {
            padding: 6px 0;
            border-bottom: 1px solid #ccc;
        }
        .qso-details {
            margin-top: 6px;
            padding: 6px;
            background: #f7f7f7;
            border: 1px solid #ddd;
        }
        .edit-btn {
            padding: 2px 8px;
            margin-left: 10px;
        }
        .dup {
            background: #ffe0e0;
        }
    </style>

    {% for qso in qsos %}
        <div class="qso-row {% if loop.index0 in duplicates %}dup{% endif %}">
            <strong>QSO {{ loop.index }}:</strong>

            CALL: {{ qso.get("call", "") }} &nbsp;
            BAND: {{ qso.get("band", "") }} &nbsp;
            MODE: {{ qso.get("mode", "") }} &nbsp;

            PARK: {{
                qso.get("pota_ref")
                or qso.get("my_sig_info")
                or qso.get("sig_info")
                or qso.get("my_sig")
                or qso.get("sig")
                or ""
            }} &nbsp;

            <button type="button" class="edit-btn" onclick="toggleDetails({{ loop.index0 }})">
                Edit
            </button>

            <form method="POST"
                  action="{{ url_for('main.delete_qso_from_upload', filename=filename, index=loop.index0) }}"
                  style="display:inline;">
                <button type="submit"
                        style="padding: 2px 8px; background:#c00; color:white;">
                    Delete QSO
                </button>
            </form>

            <div id="details_{{ loop.index0 }}" class="qso-details" style="display:none;">
                {% for field, value in qso.items() %}
                    <p>
                        <strong>{{ field }}:</strong><br>
                        <input type="text"
                               name="qso_{{ loop.index0 }}_{{ field }}"
                               value="{{ value }}"
                               style="width: 300px;">
                    </p>
                {% endfor %}
            </div>
        </div>
    {% endfor %}

    <button type="submit" style="padding: 6px 12px; margin-top: 1rem;">Save Changes</button>
</form>

<p style="margin-top: 1rem;">
    <a href="{{ url_for('main.review_uploads') }}">Back to Review</a>
</p>

</div>

<script>
function toggleDetails(i) {
    const el = document.getElementById("details_" + i);
    el.style.display = (el.style.display === "none") ? "block" : "none";
}
</script>

{% endblock %}